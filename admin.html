<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Â· Platform Console</title>

<!-- Lucide icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<style>
/* GLOBAL RESET */
*, *::before, *::after { box-sizing: border-box; }

/* DESIGN SYSTEM */
:root{
  --bg:#f5f5f7;
  --card:#fff;
  --soft:#fafafa;
  --text:#111;
  --muted:#666;
  --accent:#000;
  --border:#ddd;
  --radius-md:12px;
  --radius-lg:16px;
  --pill:999px;
  --shadow:0 8px 20px rgba(0,0,0,0.06);
  --space-2:8px;
  --space-3:12px;
  --space-4:16px;
}

/* LAYOUT */
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
body{display:flex;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}

/* SIDEBAR */
.sidebar{
  width:280px;
  background:var(--card);
  border-right:1px solid var(--border);
  padding:var(--space-4);
  display:flex;
  flex-direction:column;
  gap:var(--space-3);
}
.logo{font-weight:700;font-size:1.15rem;margin-bottom:6px}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:10px;border-radius:var(--radius-md);cursor:pointer;font-weight:600;border:2px solid transparent;
}
.nav-item:hover{background:#f0f0f0}
.nav-item.active{background:var(--soft);border-color:var(--accent)}
.nav-icon{width:18px;height:18px}

/* MAIN */
.main{flex:1;overflow:auto;padding:var(--space-4)}
.header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.section-title{font-size:1.25rem;margin:0}
.section-sub{margin:0;color:var(--muted);font-size:0.95rem}

/* CARD */
.card{background:var(--card);border-radius:var(--radius-lg);padding:var(--space-4);border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:var(--space-4)}

/* GRID */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:var(--space-4)}

/* FORM */
.field{margin-bottom:var(--space-3)}
.field label{display:block;font-size:0.8rem;margin-bottom:6px;color:var(--muted)}
.field input,.field textarea{width:100%;padding:10px;border-radius:var(--radius-md);border:1px solid #ccc;font-size:0.95rem;background:#fff}
.field textarea{min-height:90px;resize:vertical}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:10px;padding:8px 14px;border-radius:var(--pill);background:var(--accent);color:#fff;border:2px solid var(--accent);cursor:pointer;font-weight:700}
.btn.outline{background:#fff;color:#000}
.btn:disabled{opacity:0.6;cursor:not-allowed}

/* SPINNER */
.spinner{width:16px;height:16px;border:3px solid rgba(255,255,255,0.35);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;display:none}
.spinner.dark{border:3px solid rgba(0,0,0,0.15);border-top-color:#000}

/* PAGE LOADER */
.page-loader{width:40px;height:40px;border:4px solid #ccc;border-top-color:#000;border-radius:50%;animation:spin .8s linear infinite;margin:40px auto}

@keyframes spin{to{transform:rotate(360deg)}}

/* LISTS */
.list{display:flex;flex-direction:column;gap:10px}
.list-item{background:var(--soft);padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.pill{padding:4px 8px;border-radius:999px;border:1px solid #000;font-size:0.8rem}

/* CHAT */
.chat-box{display:flex;gap:10px;margin-top:12px}
.chat-box input{flex:1;padding:10px;border-radius:10px;border:1px solid #ccc}
.chat-message { width:100%; display:flex; gap:12px; align-items:flex-start; }
.chat-meta { font-size:0.85rem; color:var(--muted); margin-top:4px; }
.chat-actions { display:flex; gap:8px; align-items:center; }

/* EDIT UI */
.msg-edit { display:flex; gap:8px; margin-top:8px; }
.msg-edit input { flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; }

/* STATUS */
.status{margin-top:8px;color:#0a7a2f;font-size:0.9rem;min-height:1em}
.small{font-size:0.85rem;color:var(--muted)}
</style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="logo">Admin Console</div>

  <div class="nav-item active" data-section="announcements">
    <i data-lucide="megaphone" class="nav-icon"></i> Add Announcement
  </div>

  <div class="nav-item" data-section="rehearsal">
    <i data-lucide="calendar" class="nav-icon"></i> Add Rehearsal
  </div>

  <div class="nav-item" data-section="track">
    <i data-lucide="music" class="nav-icon"></i> Add Track
  </div>

  <div class="nav-item" data-section="video">
    <i data-lucide="video" class="nav-icon"></i> Add Video
  </div>

  <div class="nav-item" data-section="script">
    <i data-lucide="file-text" class="nav-icon"></i> Add Script URL
  </div>

  <div class="nav-item" data-section="users">
    <i data-lucide="users" class="nav-icon"></i> Manage Users
  </div>

  <div class="nav-item" data-section="chat">
    <i data-lucide="message-circle" class="nav-icon"></i> Chat Moderation
  </div>

  <div style="flex:1"></div>

  <div class="nav-item" id="logoutBtn">
    <i data-lucide="log-out" class="nav-icon"></i> Sign out
  </div>
</div>

<!-- MAIN -->
<div class="main" id="main"></div>

<script type="module">
// admin.js

//
// Requirements:
// - /firebase.js must export: auth, db, app, onAuthStateChanged
// - HTML must include elements with IDs used below (status, adminPanel, forms/buttons)
// - Adjust collection names or field validation to match your Firestore schema

import { auth, db, app, onAuthStateChanged } from '/firebase.js';
import {
  collection,
  addDoc,
  serverTimestamp,
  doc,
  setDoc,
  getDoc,
  getDocs,
  updateDoc,
  deleteDoc,
  query,
  orderBy,
  limit
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* -------------------------
   Helper UI functions
   ------------------------- */
function el(id) { return document.getElementById(id); }

function showStatus(msg, type = 'info') {
  const s = el('status');
  if (!s) return console[type === 'error' ? 'error' : 'log'](msg);
  s.textContent = msg;
  s.className = `status ${type}`;
}

function showAdminPanel(show) {
  const panel = el('adminPanel');
  if (!panel) return;
  panel.style.display = show ? 'block' : 'none';
}

/* -------------------------
   Auth and admin check
   ------------------------- */
async function isAdminUser(uid) {
  try {
    const udoc = await getDoc(doc(db, 'users', uid));
    return udoc.exists() && udoc.data().role === 'admin';
  } catch (err) {
    console.error('isAdminUser error', err);
    return false;
  }
}

async function waitForAuthAndInit() {
  // Wait for auth state to initialize
  await new Promise(resolve => {
    const unsub = onAuthStateChanged(auth, user => {
      unsub();
      resolve(user);
    });
  });

  const user = auth.currentUser;
  if (!user) {
    showStatus('Not signed in. Please sign in to access admin features.', 'error');
    showAdminPanel(false);
    return;
  }

  showStatus(`Signed in as ${user.email} (uid: ${user.uid}). Checking admin role...`, 'info');

  const admin = await isAdminUser(user.uid);
  if (!admin) {
    showStatus('You are not an admin. Admin features are disabled for this account.', 'error');
    showAdminPanel(false);
    return;
  }

  showStatus('Admin verified. You may manage content.', 'success');
  showAdminPanel(true);
  attachEventHandlers();
  await loadInitialData();
}

/* -------------------------
   CRUD operations (admin)
   ------------------------- */

// Announcements
async function createAnnouncement(title, message) {
  try {
    await addDoc(collection(db, 'announcements'), {
      title: String(title || '').trim(),
      message: String(message || '').trim(),
      createdAt: serverTimestamp()
    });
    showStatus('Announcement created.', 'success');
  } catch (err) {
    console.error('createAnnouncement error', err);
    showStatus(`Failed to create announcement: ${err.message}`, 'error');
  }
}

// Schedule
async function createScheduleItem(data) {
  try {
    // data: { title, date, time?, who?, extra? }
    await addDoc(collection(db, 'schedule'), {
      title: String(data.title || '').trim(),
      date: String(data.date || '').trim(),
      time: data.time ? String(data.time) : null,
      who: data.who ? String(data.who) : null,
      extra: data.extra ? String(data.extra) : null,
      sortTimestamp: Date.now(),
      createdAt: serverTimestamp()
    });
    showStatus('Schedule item created.', 'success');
  } catch (err) {
    console.error('createScheduleItem error', err);
    showStatus(`Failed to create schedule item: ${err.message}`, 'error');
  }
}

// Tracks
async function createTrack(title, url) {
  try {
    await addDoc(collection(db, 'tracks'), {
      title: String(title || '').trim(),
      url: String(url || '').trim(),
      createdAt: serverTimestamp()
    });
    showStatus('Track created.', 'success');
  } catch (err) {
    console.error('createTrack error', err);
    showStatus(`Failed to create track: ${err.message}`, 'error');
  }
}

// Videos
async function createVideo(title, url) {
  try {
    await addDoc(collection(db, 'videos'), {
      title: String(title || '').trim(),
      url: String(url || '').trim(),
      createdAt: serverTimestamp()
    });
    showStatus('Video created.', 'success');
  } catch (err) {
    console.error('createVideo error', err);
    showStatus(`Failed to create video: ${err.message}`, 'error');
  }
}

// Settings (single doc)
async function setSetting(docId, data) {
  try {
    await setDoc(doc(db, 'settings', docId), data, { merge: true });
    showStatus(`Setting ${docId} saved.`, 'success');
  } catch (err) {
    console.error('setSetting error', err);
    showStatus(`Failed to save setting: ${err.message}`, 'error');
  }
}

/* -------------------------
   Users management (admin)
   ------------------------- */

async function listUsers(limitCount = 50) {
  try {
    const q = query(collection(db, 'users'), orderBy('__name__'), limit(limitCount));
    const snap = await getDocs(q);
    const users = [];
    snap.forEach(d => users.push({ id: d.id, ...d.data() }));
    return users;
  } catch (err) {
    console.error('listUsers error', err);
    showStatus(`Failed to list users: ${err.message}`, 'error');
    return [];
  }
}

async function updateUserRole(uid, role) {
  try {
    await updateDoc(doc(db, 'users', uid), { role });
    showStatus(`Updated role for ${uid} to ${role}`, 'success');
  } catch (err) {
    console.error('updateUserRole error', err);
    showStatus(`Failed to update user role: ${err.message}`, 'error');
  }
}

async function deleteUserDoc(uid) {
  try {
    await deleteDoc(doc(db, 'users', uid));
    showStatus(`Deleted users/${uid}`, 'success');
  } catch (err) {
    console.error('deleteUserDoc error', err);
    showStatus(`Failed to delete user doc: ${err.message}`, 'error');
  }
}

/* -------------------------
   UI wiring and initial load
   ------------------------- */

function attachEventHandlers() {
  // Announcement form
  const annForm = el('announcementForm');
  if (annForm) {
    annForm.addEventListener('submit', async e => {
      e.preventDefault();
      const title = el('announcementTitle').value;
      const message = el('announcementMessage').value;
      await createAnnouncement(title, message);
      annForm.reset();
      await refreshUsersListIfVisible();
    });
  }

  // Schedule form
  const schedForm = el('scheduleForm');
  if (schedForm) {
    schedForm.addEventListener('submit', async e => {
      e.preventDefault();
      const data = {
        title: el('scheduleTitle').value,
        date: el('scheduleDate').value,
        time: el('scheduleTime').value,
        who: el('scheduleWho').value,
        extra: el('scheduleExtra').value
      };
      await createScheduleItem(data);
      schedForm.reset();
    });
  }

  // Track form
  const trackForm = el('trackForm');
  if (trackForm) {
    trackForm.addEventListener('submit', async e => {
      e.preventDefault();
      await createTrack(el('trackTitle').value, el('trackUrl').value);
      trackForm.reset();
    });
  }

  // Video form
  const videoForm = el('videoForm');
  if (videoForm) {
    videoForm.addEventListener('submit', async e => {
      e.preventDefault();
      await createVideo(el('videoTitle').value, el('videoUrl').value);
      videoForm.reset();
    });
  }

  // Settings form
  const settingsForm = el('settingsForm');
  if (settingsForm) {
    settingsForm.addEventListener('submit', async e => {
      e.preventDefault();
      const id = el('settingsId').value || 'default';
      const data = { value: el('settingsValue').value };
      await setSetting(id, data);
      settingsForm.reset();
    });
  }

  // Refresh users button
  const refreshUsersBtn = el('refreshUsers');
  if (refreshUsersBtn) {
    refreshUsersBtn.addEventListener('click', refreshUsersListIfVisible);
  }
}

async function loadInitialData() {
  // Optionally populate users list if the UI has a container
  await refreshUsersListIfVisible();
}

async function refreshUsersListIfVisible() {
  const container = el('usersList');
  if (!container) return;
  container.innerHTML = 'Loading users...';
  const users = await listUsers(200);
  container.innerHTML = '';
  if (!users.length) {
    container.textContent = 'No users found.';
    return;
  }
  users.forEach(u => {
    const row = document.createElement('div');
    row.className = 'userRow';
    row.innerHTML = `
      <strong>${u.id}</strong> &nbsp; ${u.email || ''} &nbsp; <em>${u.role || ''}</em>
      <button data-uid="${u.id}" class="promoteBtn">Make admin</button>
      <button data-uid="${u.id}" class="demoteBtn">Demote</button>
      <button data-uid="${u.id}" class="deleteBtn">Delete doc</button>
    `;
    container.appendChild(row);
  });

  // Attach handlers
  container.querySelectorAll('.promoteBtn').forEach(b => {
    b.addEventListener('click', async e => {
      const uid = e.currentTarget.dataset.uid;
      await updateUserRole(uid, 'admin');
      await refreshUsersListIfVisible();
    });
  });
  container.querySelectorAll('.demoteBtn').forEach(b => {
    b.addEventListener('click', async e => {
      const uid = e.currentTarget.dataset.uid;
      await updateUserRole(uid, 'member');
      await refreshUsersListIfVisible();
    });
  });
  container.querySelectorAll('.deleteBtn').forEach(b => {
    b.addEventListener('click', async e => {
      const uid = e.currentTarget.dataset.uid;
      if (!confirm(`Delete users/${uid} document? This cannot be undone from the client.`)) return;
      await deleteUserDoc(uid);
      await refreshUsersListIfVisible();
    });
  });
}

/* -------------------------
   Initialize on load
   ------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  showAdminPanel(false);
  showStatus('Initializing admin console...', 'info');
  waitForAuthAndInit().catch(err => {
    console.error('Initialization error', err);
    showStatus('Initialization failed: ' + (err.message || err), 'error');
  });
});

</script>
</body>
</html>
